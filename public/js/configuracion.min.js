$(document).ready(function() {
    ubigeo_all();
    $('#btn_datos_sunat').click(function() {
        var caracter = $('#form_agregar input[name=ruc]').val().length;
        if (caracter === 8) {
            alertify.notify('No hay conexi贸n <strong>Reniec</strong>', 'custom', 3, function() {});
        } else if (caracter === 11) {
            obtener_datos_sunat();
        } else {
            alertify.notify('No se encontro <strong>RUC 贸 DNI</strong>', 'custom', 3, function() {});
            $('#form_agregar')[0].reset();
        }
    });
    file_im = $("#file_imagen").uploadFile({
        url: "../Configuracion/upload_imagen",
        fileName: "imagen",
        acceptFiles: 'image/*',
        allowedTypes: 'jpg,png,gif',
        multiple: false,
        autoSubmit: false,
        showFileSize: true,
        showPreview: true,
        /*formData: {
            archivo: datos,
        },*/
        maxFileSize: 500000,
        /*onSuccess: function(files, data, xhr, pd) {},*/
        onSelect: function(files) {
            console.log(files);
            $('input[name=nombre]').val('logo_' + files[0].name);
        },
    });
});
$(function() {
    $("#form_agregar").on("submit", function(e) {
        e.preventDefault();
        file_im.startUpload();
        var f = $(this);
        var metodo = f.attr("method");
        var url = f.attr("action");
        var formData = new FormData(this);
        formData.append("dato", "valor");
        $.ajax({
            url: url,
            type: metodo,
            dataType: "html",
            data: formData,
            cache: false,
            contentType: false,
            processData: false,
            beforeSend: function() {
                alertify.notify('Agregando ...', 'custom-black', 3600, function() {});
            },
            success: function(data) {
                alertify.dismissAll()
                file_im.reset();
                f[0].reset();
                ubigeo_all();
                alertify.notify('Agregado correctamente', 'custom-black', 5, function() {});
            },
            error: function() {},
        });
    });
});

function obtener_datos_sunat() {
    ruc = $('#form_agregar input[name=ruc]').val();
    $.ajax({
        url: '../Sunat/datos_jossmp',
        type: "POST",
        dataType: "json",
        data: {
            'ruc': ruc
        },
        beforeSend: function() {
            alertify.notify(' <img class="loading" src="../public/img/spinner.svg"> Obteniendo <strong>DATOS</strong> <img class="alertify-sunat" src="../public/img/sunat.png" alt="">', 'custom-black', 3600, function() {});
        },
        success: function(data) {
            console.log(data);
            alertify.dismissAll();
            if (Object.entries(data).length === 0) {
                alertify.notify('No se encontro <strong>RUC 贸 DNI</strong>', 'custom', 4, function() {});
                $('#form_agregar input[name=ruc]').focus();
                $('#form_agregar')[0].reset();
                ubigeo_all();
            } else {
                alertify.notify('<strong>DATOS</strong> obtenidos correctamente', 'custom-black', 4, function() {});
                f = $('#form_agregar');
                f.find('input[name=razonsocial]').val(data['result']['RazonSocial']);
                f.find('select[name=ubigeo]').val(data['Id_ubigeo']);
                f.find('textarea[name=direccion]').val(data['Direccion_corregida']);
            }
        },
        error: function(data) {
            console.log(data);
            alertify.dismissAll();
            alertify.notify('No hay conexi贸n con <strong>SUNAT</strong>,vuelva a intentarlo o ingrese manualmente', 'custom', 6, function() {});
            $('#form_agregar input[name=ruc]').focus();
            $('#form_agregar')[0].reset();
            $("#form_agregar select[name=ubigeo]").select2({
                placeholder: "Seleccione Ciudad,Provincia,Distrito",
                allowClear: true
            });
        },
    });
}

function ubigeo_all() {
    $.ajax({
        url: '../Ubigeo/ubigeo_all2',
        type: "POST",
        dataType: "json",
        success: function(data) {
            $(".select_ubigeo option").each(function() {
                $(this).remove();
            });
            $('.select_ubigeo').append('<option value="" disabled selected>Seleccione una departamento,provincia,distrito</option>');
            $.each(data, function(i, item) {
                $('.select_ubigeo').append('<option value="' + item.id + '" >' + item.ubi_departamento + ',' + item.ubi_provincia + ',' + item.ubi_distrito + '</option>');
            });
        }
    });
}