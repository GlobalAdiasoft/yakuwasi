$(document).ready(function(){$("select[name=correlativo]").change(function(){llamar_cod($(this).val());});llamar_codpro();$("select[name=documento_modi] ,input[name=numero_modi] ").change(function(){$(".reset_datos").html(" ");
$("input[name=cli_id]").val("");$("select[name=moneda]").val("");traer_datos_factura();});$(".fecha_ui").datepicker();llamar_rucs();$("input[name=cli_id]").change(function(){llamar_cliente();
});$("input[name=codproducto]").change(function(){cod_producto($(this).val());});var a=$(".datatable").DataTable({searching:false,bLengthChange:false,paging:false,info:false,ajax:{url:"../Notadebito/traer_datos_item_nota",dataSrc:"",data:function(b){b.correlativo=$("select[name=correlativo]").val();
b.numero=$("input[name=numero]").val();}},columns:[{data:"id"},{data:"ped_cantidad"},{data:"ped_cod_pro"},{data:"ped_nombre_pro"},{data:"ped_valor_venta_sin_igv"},{data:"ped_total"},{defaultContent:"<button id='btn_eliminar2' class='btn btn-danger btn-sm'><i class='far fa-trash-alt'></i></button>"},],language:{url:"../public/fw/datatables/Spanish.json"},lengthMenu:[[100,-1],[100,"All"]]});
$(".datatable tbody").on("click","#btn_eliminar2",function(){var d=a.row($(this).parents("tr")).data();if(d==undefined){var b=$(this).parents("tr");if(b.hasClass("child")){b=b.prev();
}var c=$(".datatable").DataTable().row(b).data();alertify.confirm('<i class="fa fa-bars" aria-hidden="true"></i> Eliminar',"¿Desea eliminar el artículo <strong>"+c.ped_nombre_pro+"</strong>?",function(){eliminar(c.id);
alertify.notify("Se elimino el artículo <strong>"+c.ped_nombre_pro+"</strong> correctamente.","custom-black",4,function(){});},function(){alertify.notify("Se cancelo la <strong>eliminación</strong>.","custom-black",4,function(){});
}).set("labels",{ok:"Eliminar",cancel:"Cancelar"});}else{alertify.confirm('<i class="fa fa-bars" aria-hidden="true"></i> Eliminar',"¿Desea eliminar el artículo <strong>"+d.ped_nombre_pro+"</strong>?",function(){eliminar(d.id);
alertify.notify("Se elimino el artículo <strong>"+d.ped_nombre_pro+"</strong> correctamente.","custom-black",4,function(){});},function(){alertify.notify("Se cancelo la <strong>eliminación</strong>.","custom-black",4,function(){});
}).set("labels",{ok:"Eliminar",cancel:"Cancelar"});}});});function llamar_rucs(){$.ajax({url:"../Clientes/llamar_rucs/",type:"POST",dataType:"html",success:function(a){$("#datalist_rucs").html(a);
}});}function llamar_cliente(){var a=$("input[name=cli_id]").val();$.ajax({url:"../Clientes/llamar_cliente",type:"POST",dataType:"html",data:{id:a,},success:function(b){if(b=="vacio"){alertify.notify("No se encontraron resultados del <strong>Cliente</strong>","custom",5,function(){});
$("input[name=cli_id]").focus();$("#cli_nombre").text("");$("#cli_ruc").text(" ");$("#cli_ubigeo").text(" ");$("#cli_direccion").text(" ");$("#cli_telefono").text(" ");
$("#cli_celular").text(" ");}else{var c=JSON.parse(b);$("#cli_nombre").text(c[0].cli_nombre);$("#cli_ruc").text(c[0].cli_ruc);$("#cli_ubigeo").text(c[0].cli_ubigeo);
$("#cli_direccion").text(c[0].cli_direccion);$("#cli_telefono").text(c[0].cli_telefono);$("#cli_celular").text(c[0].cli_celular);}}});}function llamar_cod(a){$.ajax({url:"../Notadebito/llamar_cod",type:"POST",dataType:"html",data:{documento:a,},success:function(c){$("input[name=numero]").val(c);
var b=$(".datatable").DataTable();b.ajax.reload();}});}function cod_producto(a){var c=a;var b=c.split("-");var a=b[0];$.ajax({url:"../Pedidos/codpro",type:"POST",dataType:"JSON",data:{codart:a,},success:function(f){if(f==0){$("input[name=producto]").val("");
$("input[name=preciounitario]").val("");$("input[name=total]").val("");}else{$("input[name=producto]").val(f[0].art_nombre);$("input[name=valor_venta_sin_igv]").val(f[0].art_precio_ventasinigv);
$("input[name=pro_id]").val(f[0].id);var d=$("input[name=cantidad]").val();var g=$("input[name=valor_venta_sin_igv]").val();var e=d*g;$("input[name=total]").val(parseFloat(e).toFixed(2));
}}});}function traer_datos_factura(){documento=$("select[name=documento_modi]").val();numero=$("input[name=numero_modi]").val();if(numero==""){llamar_cliente();
}else{$.ajax({url:"../Notadebito/traer_datos_factura",type:"POST",dataType:"json",data:{documento:documento,numero:numero,},success:function(a){if(a.length>0){if(documento==1){$("input[name=cli_id]").val(a[0].fac_cli_id);
$("select[name=moneda]").val(a[0].fact_moneda);if(a[0].fact_moneda=="USD"){$("input[name=tipocambio]").val();}llamar_cliente();}else{$("input[name=cli_id]").val(a[0].bol_cli_id);
$("select[name=moneda]").val(a[0].bol_moneda);llamar_cliente();}}}});}}function llamar_codpro(){$.ajax({url:"../Articulos/llamar_codpro",type:"POST",dataType:"html",success:function(a){$("#datalist_codpro").html(a);
}});}function abre_ventana(){documento=$("select[name=documento_modi]").val();numero=$("input[name=numero_modi]").val();if(documento==""){$("select[name=documento_modi]").focus();
}if(numero==""){$("input[name=numero_modi]").focus();}else{if($("select[name=correlativo]").val()==null){$("select[name=correlativo]").focus();return;}if($("input[name=numero]").val()==""){$("input[name=numero]").focus();
return;}else{ventana=window.open("../Index/facturacionelectronica_nota_debito_tabla?documento="+documento+"&numero="+numero,"mywindow","toolbar=0,location=0,status=0,menubar=0,scrollbars=1,resizable=0,width=1000,height=650");
ventana.focus();}}}function actualizar(){table=$(".datatable").DataTable();table.ajax.reload();}$(function(){$("#form_agregar").on("submit",function(g){g.preventDefault();
var c=$(this);var b=c.attr("method");var a=c.attr("action");var d=new FormData(this);d.append("dato","valor");$.ajax({url:a,type:b,dataType:"html",data:d,cache:false,contentType:false,processData:false,beforeSend:function(){alertify.notify(' <img class="loading" src="../public/img/spinner.svg"> Enviando <strong>Nota de Débito</strong> a <img class="alertify-sunat" src="../public/img/sunat.png" alt="">',"custom-black",3600,function(){});
},success:function(e){alertify.dismissAll();if(e==1){alertify.notify("<strong>Nota de Débito</strong> enviada correctamente","custom-black",5,function(){});
c[0].reset();}if(e==0){alertify.notify("<strong>Nota de Débito</strong> guardada en base de datos pero no enviada","custom-black",5,function(){});c[0].reset();
}if(e==3){alertify.notify("<strong>Nota de Débito</strong> debete tener item de especificación ","custom",5,function(){});}},error:function(){},});});});
function eliminar(a){$.ajax({url:"../Notadebito/eliminar",type:"POST",dataType:"html",data:{id:a,},success:function(b){table=$(".datatable").DataTable();
table.ajax.reload();}});}function agregaritems(){var e=$("#form_agregar");var c=e.find("input[name=codproducto]").val();var g=e.find("select[name=correlativo]").val();
var b=e.find("input[name=numero]").val();var a=e.find("input[name=producto]").val();var d=e.find("input[name=cantidad]").val();if(g==null){e.find("select[name=correlativo]").focus();
}else{if(e.find("input[name=numero_modi]").val()==""){e.find("input[name=numero_modi]").focus();}else{if(c==""){e.find("input[name=codproducto]").focus();
}else{if(e.find("input[name=cantidad]").val()==""||e.find("input[name=cantidad]").val()==0){e.find("input[name=cantidad]").focus();}else{$.ajax({url:"../Notadebito/guardar_items_directo/"+c+"|"+g+"|"+b+"|"+a+"|"+d+"|",type:"POST",cache:false,processData:false,beforeSend:function(){},success:function(f){console.log(f);
table=$(".datatable").DataTable();table.ajax.reload();e.find("input[name=codproducto]").val("");e.find("input[name=producto]").val("");e.find("input[name=cantidad]").val("");
e.find("input[name=valor_venta_sin_igv]").val("");e.find("input[name=codproducto]").focus();},error:function(){},});}}}}}