$(document).ready(function() {
    var table = $('.datatable').DataTable({
        "ajax": {
            "url": '../ComprasNuevo/mostrar',
            "dataSrc": "",
            /*"data": function(d) {
                d.fechainicio = $('input[name=fecha_incio]').val();
                d.fechafinal = $('input[name=fecha_final').val();
                d.pro_busqueda = $('input[name=pro_busqueda').val();
            },*/
        },
        "columns": [{
            "data": "factura"
        }, {
            "data": "proveedor"
        }, {
            "data": "moneda"
        }, {
            "data": "subtotal"
        }, {
            "data": "igv"
        }, {
            "data": "total"
        }, {
            "data": "fecha_hora"
        }, {
            "data": "usuario"
        }, {
            "defaultContent": "<button id='btn_detalles' class='btn btn-success btn-sm'><i class='fas fa-calendar-week'></i> Detalle</button>"
        }, {
            "defaultContent": "<button id='btn_eliminar' class='btn btn-danger btn-sm'><i class='far fa-trash-alt'></i></button>"
        }, ],
    });
    var table1 = $('.datatable1').DataTable({
        "ajax": {
            "url": '../ComprasNuevo/detalles',
            "dataSrc": "",
            "data": function(d) {
                d.factura = $('input[name=cod_factura]').val();
            },
        },
        "columns": [{
            "data": "id"
        }, {
            "data": "producto"
        }, {
            "data": "cantidad"
        }, {
            "data": "precio_compra_conigv"
        }, {
            "data": "precio_compra_sinigv"
        }, {
            "data": "precio_total"
        }, {
            "defaultContent": "<button id='btn_eliminar' class='btn btn-danger btn-sm'><i class='far fa-trash-alt'></i></button>"
        }, ],
        dom: '<"row"<"col-12 col-sm-12 col-md-6"><"col-12 col-sm-12 col-md-6">>rt<"top"><"col-12"i>p',
        "lengthMenu": [
            [-1],
            ["All"]
        ],
    });
    $('.datatable tbody').on('click', '#btn_eliminar', function() {
        var data = table.row($(this).parents('tr')).data();
        if (data == undefined) {
            var selected_row = $(this).parents('tr');
            if (selected_row.hasClass('child')) {
                selected_row = selected_row.prev();
            }
            var rowData = $('.datatable').DataTable().row(selected_row).data();
            alertify.confirm('<i class="fa fa-bars" aria-hidden="true"></i> Eliminar', '¿Desea eliminar la compra  <strong>' + rowData['factura'] + '</strong>?', function() {
                eliminar(rowData['factura']);
                alertify.notify('Se elimino la compra  <strong>' + rowData['factura'] + '</strong> correctamente.', 'custom-black', 4, function() {});
            }, function() {
                alertify.notify('Se cancelo la <strong>eliminación</strong>.', 'custom-black', 4, function() {});
            }).set('labels', { ok: 'Eliminar', cancel: 'Cancelar' });
        } else {
            alertify.confirm('<i class="fa fa-bars" aria-hidden="true"></i> Eliminar', '¿Desea eliminar la compra <strong>' + data['factura'] + '</strong>?', function() {
                eliminar(data['factura']);
                alertify.notify('Se elimino la compra <strong>' + data['factura'] + '</strong> correctamente.', 'custom-black', 4, function() {});
            }, function() {
                alertify.notify('Se cancelo la <strong>eliminación</strong>.', 'custom-black', 4, function() {});
            }).set('labels', { ok: 'Eliminar', cancel: 'Cancelar' });
        }
    });
    $('.datatable tbody').on('click', '#btn_detalles', function() {
        var data = table.row($(this).parents('tr')).data();
        if (data == undefined) {
            var selected_row = $(this).parents('tr');
            if (selected_row.hasClass('child')) {
                selected_row = selected_row.prev();
            }
            var rowData = $('.datatable').DataTable().row(selected_row).data();
            detalles(rowData['factura']);
        } else {
            detalles(data['factura']);
        }
    });
    abrir_modal('modaldetalles', '<i class="fa fa-bars" aria-hidden="true"></i> Detalles de la compra');
});

function eliminar(factura) {
    $.ajax({
        url: '../ComprasNuevo/eliminar',
        type: "POST",
        dataType: "html",
        data: {
            'factura': factura,
        },
        success: function(data) {
            table = $('.datatable').DataTable();
            table.ajax.reload();
        }
    });
}

function detalles(factura) {
    var factura = $('input[name=cod_factura]').val(factura);
    table1 = $('.datatable1').DataTable();
    table1.ajax.reload();
    $('#detalles').show();
    alertify.modaldetalles($('#detalles')[0]);
}