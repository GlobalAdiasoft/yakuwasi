$(document).ready(function(){mostrar_ubigeo();llamar_rucs("BOL");$("#form_agregar_pedido select[name=tipo_documento_sel]").change(function(){if($(this).val()=="BOL"){llamar_rucs("BOL");
}else{llamar_rucs("FAC");}});var a=$(".datatable").DataTable({searching:false,bLengthChange:false,paging:false,info:false,ajax:{url:"../Pedidos/tabla_itemspedido",dataSrc:"",data:function(b){b.codigo_pedido=$("input[name=codigo_pedido]").val();
}},columns:[{data:"id"},{data:"ped_cantidad"},{data:"ped_cod_pro"},{data:"ped_nombre_pro"},{data:"ped_valor_venta_sin_igv"},{data:"ped_total"},{defaultContent:"<button id='btn_eliminar' class='btn btn-danger btn-sm'><i class='far fa-trash-alt'></i></button>"},],language:{url:"../public/fw/datatables/Spanish.json"},lengthMenu:[[100,-1],[100,"All"]]});
$(".datatable tbody").on("click","#btn_eliminar",function(){var d=a.row($(this).parents("tr")).data();if(d==undefined){var b=$(this).parents("tr");if(b.hasClass("child")){b=b.prev();
}var c=$(".datatable").DataTable().row(b).data();alertify.confirm('<i class="fa fa-bars" aria-hidden="true"></i> Eliminar',"¿Desea eliminar el artículo <strong>"+c.ped_nombre_pro+"</strong>?",function(){eliminar_pedido(c.id);
alertify.notify("Se elimino el artículo <strong>"+c.ped_nombre_pro+"</strong> correctamente.","custom-black",4,function(){});},function(){alertify.notify("Se cancelo la <strong>eliminación</strong>.","custom-black",4,function(){});
}).set("labels",{ok:"Eliminar",cancel:"Cancelar"});}else{alertify.confirm('<i class="fa fa-bars" aria-hidden="true"></i> Eliminar',"¿Desea eliminar el artículo <strong>"+d.ped_nombre_pro+"</strong>?",function(){eliminar_pedido(d.id);
alertify.notify("Se elimino el cliente <strong>"+d.ped_nombre_pro+"</strong> correctamente.","custom-black",4,function(){});},function(){alertify.notify("Se cancelo la <strong>eliminación</strong>.","custom-black",4,function(){});
}).set("labels",{ok:"Eliminar",cancel:"Cancelar"});}});$("input[name=cli_id]").change(function(){llamar_cliente();});$("input[name=valor_venta_sin_igv],input[name=cantidad]").change(function(){var c=$("input[name=cantidad]").val();
var f=$("input[name=valor_venta_sin_igv]").val();$("input[name=valor_venta_con_igv]").val($("input[name=valor_venta_sin_igv]").val()*1.18);var b=$("input[name=valor_venta_con_igv]").val();
var d=c*f;var e=c*b;$("input[name=total]").val(d);$("input[name=total_igv]").val(e);});$("input[name=valor_venta_con_igv]").change(function(){var c=$("input[name=cantidad]").val();
var f=$("input[name=valor_venta_sin_igv]").val();$("input[name=valor_venta_sin_igv]").val($("input[name=valor_venta_con_igv]").val()/1.18);var b=$("input[name=valor_venta_con_igv]").val();
var d=c*f;var e=c*b;$("input[name=total]").val(d);$("input[name=total_igv]").val(e);});$("input[name=codproducto]").change(function(){cod_producto($(this).val());
});llamar_codpro();verificar_numero_pedido();$("select[name=tipo_documento_sel]").change(function(){$("input[name=tipo_documento]").val($(this).val());
$(this).prop("disabled",true);});abrir_modal("modalagregar",'<i class="fa fa-bars" aria-hidden="true"></i> Agregar Cliente <br> <small><i class="far fa-edit"></i> Aquí podrá agregar clientes.</small>');
$("#btn_agregar").click(function(){$("#form_agregar_cliente").show();alertify.modalagregar($("#form_agregar_cliente")[0]).set("selector",'input[name="ruc"]');
actualizar_select2();});$("#btn_actualizar").click(function(){var b=$("#form_agregar_cliente input[name=ruc]");var c=b.val().length;if(c===8){datos_dni(b.val());
}else{if(c===11){datos_ruc(b.val());}else{alertify.notify("No se encontro <strong>RUC ó DNI</strong>","custom",3,function(){});}}});$("#form_agregar_pedido select[name=moneda_change]").change(function(){$("#form_agregar_pedido input[name=moneda]").val($(this).val());
$(this).prop("disabled",true);});$("input[name=tipo_documento]").val($("select[name=tipo_documento_sel]").val());$("#form_agregar_pedido input[name=moneda]").val($("#form_agregar_pedido select[name=moneda_change]").val());
$("#form_agregar_pedido select[name=moneda_change]").prop("disabled",true);});function llamar_cliente(){var a=$("input[name=cli_id]").val();a=a.split("|");
$.ajax({url:"../Clientes/llamar_cliente",type:"POST",dataType:"html",data:{id:$.trim(a[0]),},success:function(b){if(b=="vacio"){alertify.notify("No se encontraron resultados del <strong>Cliente</strong>","custom",5,function(){});
$("input[name=cli_id]").focus();$("#cli_nombre").text("");$("#cli_ruc").text(" ");$("#cli_ubigeo").text(" ");$("#cli_direccion").text(" ");$("#cli_telefono").text(" ");
$("#cli_celular").text(" ");}else{var c=JSON.parse(b);$("#cli_nombre").text(c[0].cli_nombre);$("#cli_ruc").text(c[0].cli_ruc);$("#cli_ubigeo").text(c[0].cli_ubigeo);
$("#cli_direccion").text(c[0].cli_direccion);$("#cli_telefono").text(c[0].cli_telefono);$("#cli_celular").text(c[0].cli_celular);}}});}function cod_producto(a){var c=a;
var b=c.split("|");var a=b[0];$.ajax({url:"../Pedidos/codpro",type:"POST",dataType:"JSON",data:{codart:a,},success:function(g){console.log(g);if(g==0){$("input[name=producto]").val("");
$("input[name=preciounitario]").val("");$("input[name=total]").val("");$("input[name=stock]").val("");}else{$("input[name=producto]").val(g[0].art_nombre);
$("input[name=valor_venta_sin_igv]").val(g[0].art_precio_ventasinigv);$("input[name=valor_venta_con_igv]").val(g[0].art_precio_ventaconigv);$("input[name=pro_id]").val(g[0].id);
$("input[name=stock]").val(g[0].art_stock);var e=$("input[name=cantidad]").val();var i=$("input[name=valor_venta_sin_igv]").val();var d=$("input[name=valor_venta_con_igv]").val();
var f=e*i;var h=e*d;$("input[name=total]").val(f);$("input[name=total_igv]").val(f);}}});}function llamar_rucs(a){$.ajax({url:"../Clientes/llamar_rucs/"+a,type:"POST",dataType:"html",success:function(b){$("#datalist_rucs").html(b);
}});}function llamar_codpro(){$.ajax({url:"../Articulos/llamar_codpro",type:"POST",dataType:"html",success:function(a){$("#datalist_codpro").html(a);}});
}$(function(){$("#form_agregar_pedido").on("submit",function(g){g.preventDefault();var c=$(this);var b=c.attr("method");var a=c.attr("action");var d=new FormData(this);
d.append("dato","valor");$.ajax({url:a,type:b,dataType:"html",data:d,cache:false,contentType:false,processData:false,beforeSend:function(){},success:function(f){var e=$("#form_agregar_pedido input[name=codproducto]").val();
if(f==4){alertify.notify("No se encontro <strong>Cliente</strong> en nuestra base de datos.","custom",5,function(){});$("input[name=cli_id]").focus();return;
}if(f==3){alertify.notify("No existe el producto <strong>"+e+"</strong> en nuestra base de datos.","custom",5,function(){});$("#form_agregar_pedido input[name=codproducto]").focus();
return;}if(f==1){alertify.notify("No cuenta con stock suficiente del producto <strong>"+e+".</strong>","custom",5,function(){});$("#form_agregar_pedido input[name=cantidad]").focus();
return;}if(f==2){alertify.notify("Stock mínimo del producto <strong>"+e+".</strong>","custom",5,function(){});}c.find("input[name=cantidad]").val("1");
c.find("input[name=codproducto]").val("");c.find("input[name=producto]").val("");c.find("input[name=valor_venta_sin_igv]").val("");c.find("input[name=total]").val("");
c.find("input[name=cli_id]").prop("readonly",true);c.find("select[name=tipo_documento_sel]").prop("disabled",true);c.find("input[name=stock]").val("");
$("input[name=codproducto]").focus();alertify.notify("Agregado <strong>pedido</strong> correctamente.","custom-black",5,function(){});var h=$(".datatable").DataTable();
h.ajax.reload();tabla_itemspedido_totales();},error:function(){},});});});function verificar_numero_pedido(){$.ajax({url:"../Pedidos/llamar_codigo_pedido",type:"POST",dataType:"html",success:function(a){$("input[name=codigo_pedido]").val(a);
}});}function limpiar(){location.reload();}function tabla_itemspedido_totales(){var a=$("input[name=codigo_pedido]").val();$.ajax({url:"../Pedidos/tabla_itemspedido_totales",type:"POST",dataType:"json",data:{codigo_pedido:a,},success:function(b){$(".label_subtotal,.label_igv,.label_total").html("");
$(".label_subtotal").html(b[0].subtotal);$(".label_igv").html(b[0].igv);$(".label_total").html(b[0].total);}});}function eliminar_pedido(a){$.ajax({url:"../Pedidos/eliminar_pedido",type:"POST",dataType:"html",data:{id:a,},success:function(b){table=$(".datatable").DataTable();
table.ajax.reload();tabla_itemspedido_totales();}});}function datos_ruc(a){$.ajax({url:"../Sunat/datos_jossmp/2/"+a,type:"POST",dataType:"json",data:{ruc:a},beforeSend:function(){alertify.notify(' <img class="loading" src="../public/img/spinner.svg"> Obteniendo datos <img class="alertify-sunat" src="../public/img/sunat.png" alt="">',"custom-black",3600,function(){});
},success:function(b){alertify.dismissAll();alertify.notify("Datos obtenidos <strong>correctamente.</strong>","custom-black",5,function(){});if(Object.entries(b).length===0){alertify.notify("No se encontro <strong>RUC ó DNI</strong>","custom",4,function(){});
$("#form_agregar input[name=ruc]").focus();}else{$("#form_agregar_cliente select[name=ubigeo]").select2("destroy");$("#form_agregar_cliente input[name=nombres]").val(b.result.RazonSocial);
$(" #form_agregar_cliente textarea[name=direccion]").val(b.Direccion_corregida);$("#form_agregar_cliente select[name=ubigeo]").val(b.Id_ubigeo);$("#form_agregar_cliente select[name=ubigeo]").select2();
}},error:function(){alertify.dismissAll();alertify.notify("No hay conexión con <strong>Sunat</strong>,vuelva a intentarlo o ingrese manualmente","custom",6,function(){});
},});}function datos_dni(a){$.ajax({url:"../Reniec/datos",type:"POST",dataType:"json",data:{dni:a},beforeSend:function(){alertify.notify(' <img class="loading" src="../public/img/spinner.svg"> Obteniendo datos <strong>Reniec</strong>...',"custom-black",3600,function(){});
},success:function(b){alertify.dismissAll();if(Object.entries(b).length===0){alertify.notify("No se encontro <strong>DNI</strong>","custom",3,function(){});
}else{$("#form_agregar_cliente input[name=nombres]").val(b.nombres+" "+b.apellidos);$("#form_agregar_cliente select[name=ubigeo]").select2("destroy");$("#form_agregar_cliente select[name=ubigeo]").val(b.Id_ubigeo);
$("#form_agregar_cliente select[name=ubigeo]").select2();}},error:function(){alertify.dismissAll();alertify.notify("No hay conexión con la <strong>Reniec</strong>,vuelva a intentarlo o ingrese manualmente","custom",6,function(){});
},});}function mostrar_ubigeo(){$.ajax({url:"../Clientes/mostrar_ubigeo2",type:"POST",dataType:"html",success:function(a){$("select[name = ubigeo]").append(a);
var b="Seleccione Ciudad,Provincia,Distrito";$.fn.select2.defaults.set("theme","bootstrap");$(".select2-single, .select2-multiple").select2({placeholder:b,width:null,containerCssClass:":all:"});
}});}$(function(){$("#form_agregar_cliente").on("submit",function(g){g.preventDefault();var c=$(this);var b=c.attr("method");var a=c.attr("action");var d=new FormData(this);
d.append("dato","valor");$.ajax({url:a,type:b,dataType:"html",data:d,cache:false,contentType:false,processData:false,beforeSend:function(){},success:function(e){c[0].reset();
if($("#form_agregar_pedido select[name=tipo_documento_sel]").val()=="BOL"){llamar_rucs("BOL");}else{llamar_rucs("FAC");}alertify.modalagregar().close();
},error:function(){},});});});