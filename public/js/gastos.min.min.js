$(document).ready(function() {
    $(".fechas_ui").datepicker({ dateFormat: "yy-mm-dd" });
    listar_proveedores();
    listar_usuarios();
    $(".fechas_ui").change(function() {
        a.ajax.reload();
        totales_gastos(a);
    });
    totales_gastos(a);
    var a = $(".datatable").DataTable({
        ajax: {
            url: "../Gastos/mostrar",
            dataSrc: "",
            data: function(b) {
                b.fecha_inicio = $("input[name=fecha_inicio]").val();
                b.fecha_final = $("input[name=fecha_final").val();
            },
        },
        columns: [{ data: "id" }, { data: "fecha" }, { data: "impuesto" }, { data: "costo_total" }, { data: "costo" }, { data: "porcentaje_impuesto" }, { data: "descripcion" }, { data: "usuario" }, { data: "razon" }, { data: "categoria" }, { data: "documento" }, { data: "correlativo" }, { data: "numero" }, { data: "proveedor" }, { data: "aprobado" }, { data: "nota" }, { data: "retiro" }, { data: "condicion" }, { defaultContent: "<button id='btn_editar' class='btn btn-info btn-sm' ><i class='fas fa-pencil-alt'></i></button>" }, { defaultContent: "<button id='btn_eliminar' class='btn btn-danger btn-sm'><i class='far fa-trash-alt'></i></button>" }, ],
        language: { url: "../public/fw/datatables/Spanish.json" },
        lengthMenu: [
            [10, 15, 20, -1],
            [10, 15, 20, "All"]
        ],
        dom: '<"row"<"col-12 col-sm-12 col-md-6"l><"col-12 col-sm-12 col-md-6"f>>rt<"top"B><"col-12"i>p',
        order: [
            [0, "desc"]
        ]
    });
    $(".datatable tbody").on("click", "#btn_eliminar", function() {
        var d = a.row($(this).parents("tr")).data();
        if (d == undefined) {
            var b = $(this).parents("tr");
            if (b.hasClass("child")) {
                b = b.prev();
            }
            var c = $(".datatable").DataTable().row(b).data();
            alertify.confirm('<i class="fa fa-bars" aria-hidden="true"></i> Eliminar', "¿Desea eliminar el gasto <strong>" + c.id + "</strong>?", function() {
                eliminar(c.id);
                alertify.notify("Se elimino el gasto <strong>" + c.id + "</strong> correctamente.", "custom-black", 4, function() {});
            }, function() {
                alertify.notify("Se cancelo la <strong>eliminación</strong>.", "custom-black", 4, function() {});
            }).set("labels", { ok: "Eliminar", cancel: "Cancelar" });
        } else {
            alertify.confirm('<i class="fa fa-bars" aria-hidden="true"></i> Eliminar', "¿Desea eliminar el gasto <strong>" + d.id + "</strong>?", function() {
                eliminar(d.id);
                alertify.notify("Se elimino el gasto <strong>" + d.id + "</strong> correctamente.", "custom-black", 4, function() {});
            }, function() {
                alertify.notify("Se cancelo la <strong>eliminación</strong>.", "custom-black", 4, function() {});
            }).set("labels", { ok: "Eliminar", cancel: "Cancelar" });
        }
    });
    abrir_modal("modalmodificar", '<i class="fa fa-bars" aria-hidden="true"></i> Modificar Gasto');
    $(".datatable tbody").on("click", "#btn_editar", function() {
        var d = a.row($(this).parents("tr")).data();
        if (d == undefined) { var b = $(this).parents("tr"); if (b.hasClass("child")) { b = b.prev(); } var c = $(".datatable").DataTable().row(b).data();
            editar(c.id); } else {
            editar(d.id);
        }
    });
});

function listar_proveedores() { $.ajax({ url: "../Gastos/mostrar_proveedores", success: function(a) { $("select[name=proveedor]").html(a); }, }); }

function listar_usuarios() {
    $.ajax({
        url: "../Gastos/mostrar_empleados",
        success: function(a) {
            $("select[name=aprobado]").html(a);
        },
    });
}
$(function() {
    $("#form_agregar").on("submit", function(g) {
        g.preventDefault();
        var c = $(this);
        var b = c.attr("method");
        var a = c.attr("action");
        var d = new FormData(this);
        d.append("dato", "valor");
        $.ajax({
            url: a,
            type: b,
            dataType: "html",
            data: d,
            cache: false,
            contentType: false,
            processData: false,
            beforeSend: function() {},
            success: function(e) {
                c[0].reset();
                $("#form_agregar input[name=fecha]").focus();
                table = $(".datatable").DataTable();
                table.ajax.reload();
                alertify.notify("Se agrego el <strong>Gasto</strong> correctamente.", "custom-black", 4, function() {});
            },
            error: function() {},
        });
    });
});

function eliminar(a) {
    $.ajax({
        url: "../Gastos/eliminar",
        type: "POST",
        dataType: "html",
        data: { id: a, },
        success: function(b) {
            table = $(".datatable").DataTable();
            table.ajax.reload();
        }
    });
}

function editar(a) {
    $("#form_modificar").show();
    alertify.modalmodificar($("#form_modificar")[0]);
    $.ajax({
        url: "../Gastos/mostrar_gasto",
        type: "POST",
        dataType: "json",
        data: { id: a, },
        success: function(c) {
            var b = $("#form_modificar");
            b.find("input[name=id]").val(c[0].id);
            b.find("input[name=fecha]").val(c[0].fecha);
            b.find("select[name=impuesto]").val(c[0].impuesto);
            b.find("input[name=costo_total]").val(c[0].costo_total);
            b.find("input[name=costo]").val(c[0].costo);
            b.find("input[name=porcentaje_impuesto]").val(c[0].porcentaje_impuesto);
            b.find("input[name=descripcion]").val(c[0].descripcion);
            b.find("input[name=razon]").val(c[0].razon);
            b.find("select[name=categoria]").val(c[0].categoria);
            b.find("select[name=documento]").val(c[0].documento);
            b.find("input[name=correlativo]").val(c[0].correlativo);
            b.find("input[name=numero]").val(c[0].numero);
            b.find("select[name=proveedor]").val(c[0].proveedor);
            b.find("select[name=aprobado]").val(c[0].aprobado);
            b.find("input[name=nota]").val(c[0].nota);
            b.find("input[name=retiro]").val(c[0].retiro);
        }
    });
}
$(function() {
    $("#form_modificar").on("submit", function(g) {
        g.preventDefault();
        var c = $(this);
        var b = c.attr("method");
        var a = c.attr("action");
        var d = new FormData(this);
        d.append("dato", "valor");
        $.ajax({
            url: a,
            type: b,
            dataType: "html",
            data: d,
            cache: false,
            contentType: false,
            processData: false,
            beforeSend: function() {},
            success: function(e) {
                c[0].reset();
                table = $(".datatable").DataTable();
                table.ajax.reload();
                alertify.modalmodificar().close();
                alertify.notify("<strong>Gasto</strong> modificada correctamente.", "custom-black", 3, function() {});
            },
            error: function() {},
        });
    });
});

function totales_gastos(a) {
    fechainicio = $("input[name=fecha_inicio]").val();
    fechafinal = $("input[name=fecha_final").val();
    $.ajax({
        url: "../Gastos/mostrar_totales",
        type: "GET",
        data: { fecha_inicio: fechainicio, fecha_final: fechafinal, },
        dataType: "json",
        success: function(b) {
            a.row.add({ id: "", fecha: "", impuesto: "", costo_total: "", costo: "", porcentaje_impuesto: "", descripcion: "", usuario: "", razon: "", categoria: "", documento: "", correlativo: "", numero: "", proveedor: "", aprobado: "", nota: "", retiro: "", condicion: "", "": "", "": "", }).draw();
            $(".label_costo_total").text(b.costo_total);
            $(".label_costo").text(b.costo);
        }
    });
}