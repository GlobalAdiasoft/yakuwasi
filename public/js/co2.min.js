$(document).ready(function() {
    $('select[name=proveedor]').change(function() {
        $('input[name=proveedor]').val($(this).val());
        $(this).prop("disabled", true);
    });
    $('select[name=moneda]').change(function() {
        $('input[name=moneda]').val($(this).val());
        $(this).prop("disabled", true);
    });
    $('input[name=numero_factura]').change(function() {
        $(this).prop("readonly", true);
    });
    mostrar_proveedor();
    mostrar_articulos();
    $('#form_agregar input[name=produ_precio_ventaconigv]').change(function() {
        $('#form_agregar input[name=produ_precio_ventasinigv]').val(parseFloat($('#form_agregar input[name=produ_precio_ventaconigv]').val()) / 1.18);
        var precioconigv = parseFloat($('input[name=produ_precio_ventaconigv]').val());
        var cantidad = parseFloat($('input[name=cantidad]').val());
        $('input[name=precio_total]').val(precioconigv * cantidad);
    });
    $('#form_agregar input[name=produ_precio_ventasinigv]').change(function() {
        $('#form_agregar input[name=produ_precio_ventaconigv]').val(parseFloat($('#form_agregar input[name=produ_precio_ventasinigv]').val()) * 1.18);
        var precioconigv = parseFloat($('input[name=produ_precio_ventaconigv]').val());
        var cantidad = parseFloat($('input[name=cantidad]').val());
        $('input[name=precio_total]').val(precioconigv * cantidad);
    });
    $('#form_modificar input[name=produ_precio_ventaconigv]').change(function() {
        $('#form_modificar input[name=produ_precio_ventasinigv]').val(parseFloat($('#form_modificar input[name=produ_precio_ventaconigv]').val()) / 1.18);
    });
    $('#form_modificar input[name=produ_precio_ventasinigv]').change(function() {
        $('#form_modificar input[name=produ_precio_ventaconigv]').val(parseFloat($('#form_modificar input[name=produ_precio_ventasinigv]').val()) * 1.18);
    });
    $('input[name=precio_total]').change(function() {
        var total = parseFloat($('input[name=precio_total]').val());
        var cantidad = parseFloat($('input[name=cantidad]').val());
        $('input[name=produ_precio_ventaconigv]').val(total / cantidad);
        $('#form_agregar input[name=produ_precio_ventaconigv]').trigger("change");
    });
    var table = $('.datatable').DataTable({
        "ajax": {
            "url": '../Co2/mostrar',
            "dataSrc": "",
            "data": function(d) {
                d.factura = $('#form_agregar').find('input[name=numero_factura]').val();
            },
        },
        "columns": [{
            "data": "id"
        }, {
            "data": "producto"
        }, {
            "data": "cantidad"
        }, {
            "data": "moneda"
        }, {
            "data": "precio_compra_conigv"
        }, {
            "data": "precio_total"
        }, {
            "defaultContent": "<button id='btn_eliminar' class='btn btn-danger btn-sm'><i class='far fa-trash-alt'></i></button>"
        }, ],
    });
    $('.datatable tbody').on('click', '#btn_eliminar', function() {
        var data = table.row($(this).parents('tr')).data();
        if (data == undefined) {
            var selected_row = $(this).parents('tr');
            if (selected_row.hasClass('child')) {
                selected_row = selected_row.prev();
            }
            var rowData = $('.datatable').DataTable().row(selected_row).data();
            alertify.confirm('<i class="fa fa-bars" aria-hidden="true"></i> Eliminar', '¿Desea eliminar el artículo <strong>' + rowData['producto'] + '</strong>?', function() {
                eliminar(rowData['id']);
                alertify.notify('Se elimino el artículo <strong>' + rowData['producto'] + '</strong> correctamente.', 'custom-black', 4, function() {});
            }, function() {
                alertify.notify('Se cancelo la <strong>eliminación</strong>.', 'custom-black', 4, function() {});
            }).set('labels', { ok: 'Eliminar', cancel: 'Cancelar' });
        } else {
            alertify.confirm('<i class="fa fa-bars" aria-hidden="true"></i> Eliminar', '¿Desea eliminar el artículo <strong>' + data['producto'] + '</strong>?', function() {
                eliminar(data['id']);
                alertify.notify('Se elimino el artículo<strong>' + data['producto'] + '</strong> correctamente.', 'custom-black', 4, function() {});
            }, function() {
                alertify.notify('Se cancelo la <strong>eliminación</strong>.', 'custom-black', 4, function() {});
            }).set('labels', { ok: 'Eliminar', cancel: 'Cancelar' });
        }
    });
});

function mostrar_proveedor() {
    $.ajax({
        url: '../Proveedores/mostrar_select',
        type: "POST",
        dataType: "html",
        success: function(data) {
            $('select[name = proveedor]').append(data);
            $('select[name = proveedor]').select2();
        }
    });
}

function mostrar_articulos() {
    $.ajax({
        url: '../Compras/mostrar_select',
        type: "POST",
        dataType: "html",
        success: function(data) {
            $('select[name=articulo] option').each(function() {
                $(this).remove();
            });
            $('select[name=articulo]').append('<option value="" disabled selected>Seleccione un artículo</option>');
            $('select[name=articulo]').append(data);
            $('select[name=articulo]').select2();
        }
    });
}
$(function() {
    $("#form_agregar").on("submit", function(e) {
        e.preventDefault();
        var f = $(this);
        var metodo = f.attr("method");
        var url = f.attr("action");
        var formData = new FormData(this);
        formData.append("dato", "valor");
        $.ajax({
            url: url,
            type: metodo,
            dataType: "html",
            data: formData,
            cache: false,
            contentType: false,
            processData: false,
            beforeSend: function() {},
            success: function(data) {
                table = $('.datatable').DataTable();
                table.ajax.reload();
                $('input[name=cantidad]').val('');
                $('input[name=produ_precio_ventaconigv]').val('');
                $('input[name=produ_precio_ventasinigv]').val('');
                $('input[name=precio_total]').val('');
                $('select[name=articulo]').select2('open');
                calcular();
            },
            error: function() {},
        });
    });
});

function calcular() {
    var factura = $('#form_agregar').find('input[name=numero_factura]').val();
    $.ajax({
        url: '../Co2/calcular',
        type: "POST",
        dataType: "json",
        data: {
            'factura': factura,
        },
        success: function(data) {
            console.log(data);
            $('.label_subtotal').html(data[0].subtotal);
            $('.label_igv').html(data[0].igv);
            $('.label_total').html(data[0].total);
        }
    });
}

function eliminar(id) {
    $.ajax({
        url: '../Co2/eliminar',
        type: "POST",
        dataType: "html",
        data: {
            'id': id,
        },
        success: function(data) {
            table = $('.datatable').DataTable();
            table.ajax.reload();
            calcular();
        }
    });
}